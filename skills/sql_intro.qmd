---
execute: 
  echo: true
draft: false
output: markup
categories: [SQL, beginner]
params:
  sl_date: 2025-11-27
  fn: An introduction to SQL
  id: KS14
title: An introduction to SQL
date: '`r params[["sl_date"]]`'
---


```{r}
#| results: asis
#| fig-align: left
#| fig-height: 0.6
#| fig-width: 3
#| echo: false

source(here::here("R/feed_block.R"))
feed_block(params[["id"]])

source(here::here("R/next_sesh.R"), local = T)
next_sesh(params[["fn"]])
```



{{< include src/sql_about.qmd >}}


## About this session

This introductory session aims to give you a quick and easy introduction to SQL. That will include:

* how data is held in SQL (as tables)
* how you can investigate that data using SQL queries
* and showing some of the basic tools that you can use to query and reshape data in SQL

## Setup

* You will need a free [posit.cloud](https://posit.cloud/) account. Please set this up and check that you have access before the session begins
* Once you've logged-in to [posit.cloud](https://posit.cloud/), please create a new Rstudio project from Github Repository </br>![New Rstudio project](src/images/sql_new_from_repo.png)
* Supply the following URL when prompted: [https://github.com/NES-DEW/KIND_sql_intro/](https://github.com/NES-DEW/KIND_sql_intro/)
* Once the project is deployed, open the `s1_setup.R` script by from the bottom-right hand files pane
* Click the `Source` button at the top right-hand corner of the source pane ![Source button](src/images/sql_source_script.png)
* Then open the `s1_intro.sql` script from the files pane, and `Ctrl` + `Shift` + `Enter` twice to preview your data for this session


:::{.callout-note collapse=true appearance='default' icon=true}
## Manual setup instructions

* You will need a free [posit.cloud](https://posit.cloud/) account. Please set this up and check that you have access before the session begins
* Once you've logged-in to [posit.cloud](https://posit.cloud/), please create a new Rstudio project </br>![New Rstudio project](src/images/sql_intro_create_project.png)
* In that project, create a new R script: </br>![Create a new R script from the file menu](src/images/sql_intro_create_script.png)
* Copy and paste the following R code into that script:

```{r r-script}
#| eval: false

## install and attach R packages
pkg <- c("dbplyr", "RSQLite", "palmerpenguins")
install.packages(setdiff(pkg, rownames(installed.packages())))  
library(dbplyr)
library(dplyr)
library(palmerpenguins)

conn <- src_memdb() # create an sqlite db in memory
copy_to(conn, penguins, overwrite = T) # populate that db from R
```


```{r}
#| echo: false
library(dbplyr)
library(dplyr)
library(palmerpenguins)

conn <- src_memdb() # create an sqlite db in memory
copy_to(conn, penguins) # populate that db from R
```

* save your script and click the `Source` button
    * that will create a simple SQL database in memory
* now create a new SQL script (again, from the `File` menu)
* delete all the pre-populated lines of code, as follows: </br>![Pre-populated code in new SQL script](src/images/new_sql.png)
* to connect with our SQL db in memory, add the following line to the head of your SQL script:

```{sql connection=src_memdb()$con}
#| eval: false
-- !preview conn=src_memdb()$con
```

* finally, save your SQL script (any file name is fine)

:::

## Getting started

Our db has one table, named `penguins`. A table is similar to an Excel sheet - a rectangular set of rows and columns containing our data. To preview our data, we'll need to write a first line of SQL. Please add the following to the bottom of your SQL script:

```{sql connection=src_memdb()$con}
SELECT * FROM penguins;
```

* SQL queries usually start with the `SELECT` keyword, which retrieves data from the database
* `*` means "show me everything!"
* `FROM penguins` specifies that we want everything from the penguins table. That specification is important, because most real-life SQL set-ups will have multiple tables of data
* `;` ends the line. Not essential, but good practice
* **Important:** press `Ctrl` + `Shift` + `Enter` in the source code pane to run your SQL script

## Playing with that query

* We'll now change that one query to do something slightly different
* Unlike most other languages, you'll write SQL queries one at a time
* Add a new keyword `LIMIT 5` at the end of your query to produce a shorter preview of our data:

```{sql connection=src_memdb()$con}
SELECT * FROM penguins LIMIT 5;
```

* SQL is case insensitive - including for column names etc - but it's customary to use capitals for the keywords. It makes your SQL easier to read, too.

:::{.callout-note collapse=false appearance='default' icon=true}
## Exercise
+ please could you modify your SQL statement to preview the first 10 rows of the data
:::

## Comments

* If you want to turn off some of your SQL, or add notes, you can include comments
* `--` double-dash to comment a line, or part of a line
* `/*` and then `*/` slash-star to comment a multi-line chunk

```{sql connection=src_memdb()$con}
SELECT * FROM penguins LIMIT 5; -- comment in the line

/* or a longer chunk
This code is so I can see the top 5 lines of the penguins table 
*/  
```

## Columns

* you can select some of your columns by changing the `SELECT *` keyword
    - the `*` we've been using so far is a wildcard, which shows all the columns in your table
* add column name(s) to retrieve just parts of your data

```{sql connection=src_memdb()$con}
SELECT species, island FROM penguins;
```

+ note that columns are returned in the order you ask for them
+ you can also rename selected columns using `AS`:

```{sql connection=src_memdb()$con}
SELECT species, island AS landmass
    FROM penguins;
```

* note too that SQL is insensitive to whitespace, so you can generally split up longer queries over many lines
* an alternative strategy (if you're brave) is to use implicit renaming:

```{sql connection=src_memdb()$con}
SELECT island landmass FROM penguins;
```

:::{.callout-note collapse=false appearance='default' icon=true}
## Exercise
+ please select the `species` and `flipper_length_mm` columns with new names of your choice
:::


## Distinct values

```{sql connection=src_memdb()$con}
SELECT DISTINCT species FROM penguins;
```

* `DISTINCT` gathers the unique values in a column, or unique combinations of values across multiple columns
* this second query gives you all the combinations of penguins and islands that exist in our data:
    
```{sql connection=src_memdb()$con}
SELECT DISTINCT island, species FROM penguins;
```

## Dislcaimer - SQL dialects
If you’re planning to use some of the SQL we’ve covered in this course so far, it’s worth being aware of a few caveats before querying different database types.

* SQL has been around for a [very long time](https://en.wikipedia.org/wiki/SQL), and has been used in lots of different ways
* That means there are several slightly different dialects of SQL which are (unfortunately) incompatible
* We'll largely ignore those differences in this beginner's training
* But, just to illustrate, the `LIMIT` keyword is one that only works in some types of SQL
* If you were using Microsoft's dialect of SQL (which they refer to [as Transact-SQL, or T-SQL](https://learn.microsoft.com/en-us/sql/t-sql/language-reference?view=sql-server-ver17)), you'd need to write something slightly different (and reordered, thanks to John Mackintosh for the correction):

```{sql}
#| eval: false
SELECT TOP 5 * from penguins;
```

* Or if you were using Oracle's newest dialect of SQL, you'd write either:

```{sql}
#| eval: false
SELECT * FROM penguins FETCH FIRST 5 ROWS ONLY;
```

* Or, an older - but possibly neater - way of writing Oracle SQL:

```{sql}
#| eval: false
SELECT * FROM penguins WHERE ROWNUM <= 5;
```

## SQL query summary

```{sql connection=src_memdb()$con}
#| code-fold: true
#| eval: false

SELECT * FROM penguins; -- show all your data

SELECT * FROM penguins LIMIT 5; -- showing the first five rows of your data

SELECT species, island FROM penguins; -- showing just the species and island columns

SELECT species, island AS landmass FROM penguins; -- selecting and re-naming columns

SELECT island landmass FROM penguins; -- you can also implicitly rename, if you're brave...

SELECT DISTINCT species FROM penguins; -- selecting distinct values from the species column

SELECT DISTINCT island, species FROM penguins; -- selecting distinct combinations of island and species
```
## Acknowledgements

Like all our courses and sessions, this is a team effort, and I thank the network as a whole for their encouragements and contributions. Specific thanks in this case go to Amanda King (NHS GGC), Steven Knapman (NHS Fife), and James McMahon (Public Health Scotland), and to the members of the pilot cohort for this session.
