<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2024-09-05">

<title>Debugging R – KIND training pages</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-549806ee2085284f45b00abea8c6df48.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark-8ea72dc5fed832574809a9c94082fbbb.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-5027bf1c1f92ac6615724d89c8213d6a.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark-22155e0a9ec0237f22fbd19bb7fb02cb.min.css" rel="prefetch" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script src="../site_libs/quarto-contrib/iconify-2.1.0/iconify-icon.min.js"></script>
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">KIND training pages</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../excel_main.html"> 
<span class="menu-text">Excel</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../r_main.html"> 
<span class="menu-text">R</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../BI_main.html"> 
<span class="menu-text">Power BI</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../tableau_main.html"> 
<span class="menu-text">Tableau</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../skills_main.html"> 
<span class="menu-text">Skills</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../schedule.html"> 
<span class="menu-text">📅 Training schedule</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
    <div class="dropdown">
      <a href="" title="" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" role="link" aria-label=""><i class="bi bi-github"></i></a>
      <ul class="dropdown-menu" aria-labelledby="quarto-navigation-tool-dropdown-0">
          <li>
            <a class="dropdown-item quarto-navbar-tools-item" href="https://github.com/NES-DEW/KIND-training">
            Source Code
            </a>
          </li>
          <li>
            <a class="dropdown-item quarto-navbar-tools-item" href="https://github.com/NES-DEW/KIND-training/issues">
            Report a Bug
            </a>
          </li>
      </ul>
    </div>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#debugging-r" id="toc-debugging-r" class="nav-link active" data-scroll-target="#debugging-r">Debugging R</a></li>
  <li><a href="#session-outline" id="toc-session-outline" class="nav-link" data-scroll-target="#session-outline">Session outline</a></li>
  <li><a href="#avoiding-errors" id="toc-avoiding-errors" class="nav-link" data-scroll-target="#avoiding-errors">Avoiding errors</a></li>
  <li><a href="#how-is-your-code-broken" id="toc-how-is-your-code-broken" class="nav-link" data-scroll-target="#how-is-your-code-broken">How is your code broken?</a>
  <ul class="collapse">
  <li><a href="#my-code-wont-run-at-all" id="toc-my-code-wont-run-at-all" class="nav-link" data-scroll-target="#my-code-wont-run-at-all">My code won’t run at all</a></li>
  <li><a href="#im-getting-an-error-message" id="toc-im-getting-an-error-message" class="nav-link" data-scroll-target="#im-getting-an-error-message">I’m getting an error message</a></li>
  <li><a href="#my-output-is-wonky" id="toc-my-output-is-wonky" class="nav-link" data-scroll-target="#my-output-is-wonky">My output is wonky</a></li>
  </ul></li>
  <li><a href="#pin-pointing-problems" id="toc-pin-pointing-problems" class="nav-link" data-scroll-target="#pin-pointing-problems">Pin-pointing problems</a>
  <ul class="collapse">
  <li><a href="#read-the-error-message" id="toc-read-the-error-message" class="nav-link" data-scroll-target="#read-the-error-message">Read the error message</a></li>
  <li><a href="#finding-errors" id="toc-finding-errors" class="nav-link" data-scroll-target="#finding-errors">Finding errors</a></li>
  <li><a href="#check-the-basic-stuff" id="toc-check-the-basic-stuff" class="nav-link" data-scroll-target="#check-the-basic-stuff">Check the basic stuff</a></li>
  </ul></li>
  <li><a href="#isolating-errors" id="toc-isolating-errors" class="nav-link" data-scroll-target="#isolating-errors">Isolating errors</a>
  <ul class="collapse">
  <li><a href="#make-a-minimal-example" id="toc-make-a-minimal-example" class="nav-link" data-scroll-target="#make-a-minimal-example">Make a minimal example</a></li>
  <li><a href="#reprex" id="toc-reprex" class="nav-link" data-scroll-target="#reprex">Reprex</a></li>
  </ul></li>
  <li><a href="#finding-help" id="toc-finding-help" class="nav-link" data-scroll-target="#finding-help">Finding help</a></li>
  <li><a href="#fancier-stuff" id="toc-fancier-stuff" class="nav-link" data-scroll-target="#fancier-stuff">Fancier stuff</a></li>
  </ul>
</nav>
    <div class="quarto-margin-footer"><div class="margin-footer-item">
<p xmlns:cc="http://creativecommons.org/ns#" xmlns:dct="http://purl.org/dc/terms/">
<a property="dct:title" rel="cc:attributionURL" href="https://nes-dew.github.io/KIND-training">KIND learning network training materials</a> by <span property="cc:attributionName">KIND learning network</span> is licensed under <a href="https://creativecommons.org/licenses/by-sa/4.0/?ref=chooser-v1" target="_blank" rel="license noopener noreferrer" style="display:inline-block;">CC BY-SA 4.0<img style="height:16px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/cc.svg?ref=chooser-v1" alt=""><img style="height:16px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/by.svg?ref=chooser-v1" alt=""><img style="height:16px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/sa.svg?ref=chooser-v1" alt=""></a>
</p>
</div></div></div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Debugging R</h1>
  <div class="quarto-categories">
    <div class="quarto-category">R</div>
    <div class="quarto-category">beginner</div>
    <div class="quarto-category">troubleshooting</div>
  </div>
  </div>



<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">September 5, 2024</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="true" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Session materials
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse show">
<div class="callout-body-container callout-body">
<p>There’s also a practical exercise associated with this training session. It’s a compendium of different, common, R errors for you to troubleshoot. It’s not at all true-to-life, but is instead <a href="https://en.wikipedia.org/wiki/Wound_Man">a ghastly scope-of-the-possible</a> with something over forty distinct problems to fix.</p>
<ul>
<li><a href="src/wound_man.R">very broken R script <iconify-icon inline="" icon="mdi:language-r" style="font-size: 2em;" aria-label="Icon language-r from mdi Iconify.design set." title="Icon language-r from mdi Iconify.design set."></iconify-icon></a></li>
<li><a href="src/wound_man_fixed.R">fixed R script with comments <iconify-icon inline="" icon="mdi:language-r" style="font-size: 2em;" aria-label="Icon language-r from mdi Iconify.design set." title="Icon language-r from mdi Iconify.design set."></iconify-icon></a></li>
</ul>
</div>
</div>
</div>
<div class="cell" data-layout-align="left">
<p>No feedback found for this session</p>
</div>
<section id="debugging-r" class="level2">
<h2 class="anchored" data-anchor-id="debugging-r">Debugging R</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/clipboard-3516250507.png" height="300" class="figure-img"></p>
<figcaption>My sequence of R errors while writing this training session. These pages are published via a GitHub action which can be a bit complex to troubleshoot. I’m definitely still a beginner at that</figcaption>
</figure>
</div>
<ul>
<li>R code often misbehaves
<ul>
<li>that’s true of code in general - it’s not specific to R</li>
</ul></li>
<li>learning to manage errors and problems effectively is a long-term learning issue
<ul>
<li>most programmers, no matter their level of expertise, spent much of their time fixing problems</li>
</ul></li>
<li>this session is designed to give you a basic toolkit of strategies for dealing with broken code</li>
</ul>
</section>
<section id="session-outline" class="level2">
<h2 class="anchored" data-anchor-id="session-outline">Session outline</h2>
<ul>
<li>Avoiding errors</li>
<li>Types of broken code</li>
<li>Pin-pointing problems</li>
<li>Isolating errors</li>
<li>Finding help</li>
<li>Fancier stuff</li>
</ul>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>most of the troubleshooting advice is fairly general, and should apply to R no matter how you’re running it</li>
<li>however, there are a few Rstudio / Posit-specific tips in the section on non-running code</li>
</ul>
</div>
</div>
</section>
<section id="avoiding-errors" class="level2">
<h2 class="anchored" data-anchor-id="avoiding-errors">Avoiding errors</h2>
<p>The best kind of troubleshooting is no troubleshooting. You can avoid errors by:</p>
<ul>
<li>planning carefully before writing proper code - I write the script in comments first, then translate into code. This has the useful side-effect of annotating the code for no extra effort</li>
<li>working in a logical sequence from start to finish</li>
<li>keeping code simple and legible. That means short scripts with <code>source()</code>, and using functions and functional programming to avoid repetitious code</li>
<li>avoiding creating loads of variables (do a lot of things directly if you don’t need the data for later), and careful variable naming</li>
<li>refactoring messy code at the time to keep it clean</li>
<li>keeping code formatted nicely</li>
</ul>
<p>I see a lot of broken code, and the commonest cause by far is excessive script length and complexity. Learning to write functions is the single greatest thing you can do to make your code simpler and thus avoid bugs.</p>
</section>
<section id="how-is-your-code-broken" class="level2">
<h2 class="anchored" data-anchor-id="how-is-your-code-broken">How is your code broken?</h2>
<section id="my-code-wont-run-at-all" class="level3">
<h3 class="anchored" data-anchor-id="my-code-wont-run-at-all">My code won’t run at all</h3>
<p>This is the commonest, hard-to-solve error that most of us encounter. It usually means that R is having some unusual difficulty in recognizing the R code you’re written <em>as being</em> R code. It’s hard to solve because you don’t have a nice informative error message (or anything else) to look at. Things to check at this point are:</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
A list of generic R troubleshooting strategies
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>make sure the last line of the console has a <code>&gt;</code> rather than a <code>+</code>. If you see <code>+</code>, R is waiting for you to do something. Press <code>Esc</code> a couple of times, then try your code again</li>
<li>try running some new code in the console (<code>2 + 2</code> if more than enough)</li>
<li>restart R (<code>Ctrl</code> + <code>Shift</code> + <code>F10</code>)</li>
<li>terminate R (<code>Session</code> menu)</li>
<li>close and reopen Rstudio (or hard-refresh <code>Ctrl</code>+<code>F5</code> the page for Posit)</li>
<li>make sure the code you’re trying to run is saved as an .R file</li>
<li>if you’re on the desktop, make sure you have <a href="https://a-little-book-of-r-for-time-series.readthedocs.io/en/latest/src/installr.html">R installed on your machine</a></li>
<li>try opening a different project and seeing if that code will run</li>
</ol>
</div>
</div>
</section>
<section id="im-getting-an-error-message" class="level3">
<h3 class="anchored" data-anchor-id="im-getting-an-error-message">I’m getting an error message</h3>
<p>Most R error messages tell you what’s wrong by providing an error message in the console. In fact, many R functions will also tell you what’s gone right there too. The term of art here is that R code is generally <em>surly</em> - it complains a lot, even when things are going right. Here, we’re going to ignore those informative messages, and concentrate on proper errors that prevent your code from running properly.</p>
</section>
<section id="my-output-is-wonky" class="level3">
<h3 class="anchored" data-anchor-id="my-output-is-wonky">My output is wonky</h3>
<p>The opposite problem: your code seems to run perfectly, but you don’t get the output you’re expecting. Given that you don’t have an error message to work from, you’ll need to try and work backwards from the output you’re expecting. But a few examples of output that’s gone wrong:</p>
<ul>
<li>numeric values are bigger/smaller than expected</li>
<li>text is incorrect, poorly-formatted, squishedtogether, or IN THE WRONG CASE</li>
<li>graphs miss values or mis-represent values</li>
<li>the possibilities are endless</li>
</ul>
<p>In general, finding and fixing output problems is a manual business. You should expect to have output errors in new code, and it’s important to allow yourself time and space to both check for errors, and to resolve them.</p>
</section>
</section>
<section id="pin-pointing-problems" class="level2">
<h2 class="anchored" data-anchor-id="pin-pointing-problems">Pin-pointing problems</h2>
<p>To solve an error you’ll almost always need to refine your understanding of a) what’s gone wrong, and b) where it’s gone wrong.</p>
<section id="read-the-error-message" class="level3">
<h3 class="anchored" data-anchor-id="read-the-error-message">Read the error message</h3>
<p>Obvious but takes practice. Most R error messages give you clues as to how to find and fix the problem. The key here is that a) the message will contain the word <code>Error</code> and b) your code will stop running. Many errors from more recent packages have nice explanations and fixes. In general, the older the function, the more difficult the error. That wasn’t always the case, and some older R functions have horrid error messages. Here’s a short dictionary for some classics:</p>
<ul>
<li><code>could not find function ‘thing’</code> = you’ve mis-spelled a function name or failed to load a package</li>
<li><code>there is no package called ‘glok’</code> = you’ve mis-spelled a package name - or you haven’t installed it</li>
<li><code>object 'mpg' not found</code> = you haven’t created an object, or you’ve missed a pipe somewhere</li>
<li><code>non-numeric argument to binary operator</code> = you’ve tried to do maths with words somewhere</li>
<li><code>longer object length is not a multiple of shorter object length</code> or <code>length of 'dimnames' [2] not equal to array extent</code> = <a href="https://eriqande.github.io/rep-res-web/lectures/vectorization_recycling_and_indexing.html">you’ve fallen into vector recycling rules</a></li>
<li>lots of weird errors about <code>filter</code> - make sure you’re using <code>dplyr::filter</code> specifically</li>
</ul>
</section>
<section id="finding-errors" class="level3">
<h3 class="anchored" data-anchor-id="finding-errors">Finding errors</h3>
<p>Unlike many programming languages, R doesn’t give you a line number for errors. It is <a href="https://stackoverflow.com/questions/1445964/how-to-get-r-script-line-numbers-at-error">possible, but a bit messy</a>, to add line numbers, but might be worth it if you’re coming from Python or similar. You can usually see the malfunctioning line of code immediately above the error message in the console.</p>
<p>If your error message isn’t that helpful, you can try running the <code>traceback()</code> command in the console, which will show you the series of steps that led to your last error. The trick here is to read bottom-to-top: the top of the <code>traceback()</code> output was the last function that ran before R fell over.</p>
<p>You can also, if you’re getting desperate, try some old-fashioned print debugging, by putting some <code>print("some label")</code> statements into your code. They’ll appear in the console, so you might be able to detect the location of your error if all else fails. But really, if you’re at this point you should probably move onto a more involved strategy…</p>
</section>
<section id="check-the-basic-stuff" class="level3">
<h3 class="anchored" data-anchor-id="check-the-basic-stuff">Check the basic stuff</h3>
<p>If that hasn’t worked, we’re into debugging proper. So, at this point, make sure that you’ve restart R to clean up your environment, run your code again, and then looked carefully at your output/error message to decide what’s wrong with it. At this point, I’d also try to write the problem down, which is an effective but irrational strategy that often seems to yield results.</p>
<p>Assuming that fails, we can run through a set of quick checks that are always worth trying:</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
A list of basic code errors
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>check your brackets - <code>Code</code> &gt; <code>Rainbow parentheses</code> (or <em>rainbow brackets</em> for those of us in British-inflected English) are fantastic for this</li>
<li>look for easy transpositions like <code>&lt;</code> / <code>&gt;</code>, <code>+</code> / <code>-</code></li>
<li>check that your function names are correct, and you’re not accidentally using false-friends (<code>class()</code> and <code>typeof()</code> are really nice examples)
<ol type="1">
<li>a quick check of each function’s help at this point, just to check it really does what you think it does, is highly recommended</li>
</ol></li>
<li>ensure all your packages are installed and loaded. If in doubt, use namespacing <code>package::function</code></li>
<li>make sure that you’re actually looking at this code’s output, and haven’t accidentally calculated something without showing it…</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">+</span><span class="dv">5</span><span class="sc">+</span><span class="dv">8</span><span class="sc">+</span><span class="dv">9</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(results) <span class="co"># slightly different variable name</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="isolating-errors" class="level2">
<h2 class="anchored" data-anchor-id="isolating-errors">Isolating errors</h2>
<p>If you can’t find your problem fairly easily, then you need to cut your code down to size to make your search easier.</p>
<section id="make-a-minimal-example" class="level3">
<h3 class="anchored" data-anchor-id="make-a-minimal-example">Make a minimal example</h3>
<p>The best advice for tricky problems is to make your problem as specific as problem. That means removing any irrelevant code. We’ll call this the minimal example. Assuming that you’ve already tried the sequence of basic troubleshooting steps above, you’d go about it as follows:</p>
<ol type="1">
<li><strong>switch off</strong> any unnecessary parts of your code to pin down where the error is happening
<ol type="1">
<li>you can do that by adding <code>#</code> or <code>Ctrl</code>+<code>Shift</code>+<code>c</code></li>
<li>or, <strong>probably cognitively better</strong>, copy the misbehaving code to a new script</li>
</ol></li>
<li>try to run that extracted piece of code (again, probably after restarting R)
<ol type="1">
<li>you’ll almost certainly need to load packages, and add other pieces of code to get it to run</li>
<li>whatever you do, do the minimum. No loading all the usual packages, no copy-pasting great gobbets of code around the place, just try and keep the script as simple as possible</li>
</ol></li>
<li>when you’ve got the code to run, you’ll either:
<ol type="1">
<li>have the same error again, in which case you’re in a much better position to do the same thing again to localise the error within that new, simpler, script you’ve just built</li>
<li>have fixed the error, in which case you now know what you need to look elsewhere in your original code for the source of the problem</li>
<li>have given yourself a brand-new error to focus on. Lucky you! Definitely try to fix that new error before proceeding</li>
</ol></li>
</ol>
<p>If that doesn’t work, it’s time to look up the chain to the inputs of this piece of code. I’d work as follows:</p>
<ol type="1">
<li>check for <strong>types</strong> - so if you’re expecting your code to add numbers together, ensure that your inputs are both numbers</li>
<li>check that the <strong>variable names</strong> line up</li>
<li>check that there’s <strong>no other code</strong> that could potentially alter any of your inputs</li>
<li>finally, <strong>repeat the isolation exercise</strong> above for each input</li>
</ol>
</section>
<section id="reprex" class="level3">
<h3 class="anchored" data-anchor-id="reprex">Reprex</h3>
<p>= <strong>repr</strong>oducible <strong>ex</strong>ample. See the <a href="https://reprex.tidyverse.org/">documentation for the reprex package</a>, especially the <a href="https://reprex.tidyverse.org/articles/reprex-dos-and-donts.html">helpful set of do’s and don’t</a>.</p>
<p>If the minimal example method above doesn’t find your problem, you’re probably going to need to ask for help. Luckily, the preparatory work you’ll need for that is itself directly helpful in solving your problem.</p>
<p>Generally, when people want to help you with your R code, the first thing they’ll want to do is to run it. A reprex is a way of packaging up everything your code needs so that anyone can copy and paste it. This is important, because a bare snippet of code doesn’t tell the full story. For example, say this bit of code isn’t working for me:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>my_data <span class="sc">|&gt;</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="at">flavours =</span> <span class="st">"chocolate"</span>) <span class="sc">|&gt;</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transmogrify</span>() </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>A potential ally and helper won’t be able to assist me with this as it stands. They won’t know about my data, they won’t know which packages I’m using, and (last line) they won’t even recognize the function name that I just made up. To save a lot of annoying back and forth, you should turn this into a minimal example (see above), and then use reprex to help your helpers. I need at least the following bits to make this code reproducible:</p>
<ul>
<li>the data</li>
<li>an idea of which package the <code>filter()</code> comes from</li>
<li>a definition of <code>transmogrify()</code></li>
</ul>
<p>That breaks down as follows:</p>
<ul>
<li>provide a short snippet of data</li>
<li>include any relevant package loading</li>
<li>include the function definition for any non-package functions</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>my_data <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">tibble</span>(<span class="at">flavours =</span> <span class="fu">c</span>(<span class="st">"chocolate"</span>, <span class="st">"onion"</span>, <span class="st">"chocolate"</span>),</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>                  <span class="at">scoop_size =</span> <span class="fu">c</span>(<span class="dv">100</span>,<span class="dv">120</span>,<span class="dv">100</span>),</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">count =</span> <span class="fu">c</span>(<span class="dv">200</span>,<span class="dv">500</span>,<span class="dv">400</span>)) <span class="co"># give a preview of the data in a copy/pastable format</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>transmogrify <span class="ot">&lt;-</span> <span class="cf">function</span>(df){</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  df <span class="sc">|&gt;</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">summarise</span>(<span class="at">total_vol_l =</span> <span class="fu">sum</span>(scoop_size <span class="sc">*</span> count)<span class="sc">/</span><span class="dv">1000</span>) <span class="co"># add the function definition</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>my_data <span class="sc">|&gt;</span> <span class="co"># I can now run this and find the error!</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="at">flavours =</span> <span class="st">"chocolate"</span>) <span class="sc">|&gt;</span> <span class="co"># dplyr's filter</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transmogrify</span>() </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<blockquote class="blockquote">
<p>This usually means that you’ve used <code>=</code> instead of <code>==</code>.</p>
</blockquote>
<p>Getting data together for a reprex is the most painful bit, particularly if you’re dealing with something real-world and lengthy. I like the <a href="https://milesmcbain.github.io/datapasta/">datapasta</a> package for this, as it has the useful function <code>tribble_format</code> that will take some data and turn it into a copy/pastable format that you can use in a reprex.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>datapasta<span class="sc">::</span><span class="fu">tribble_format</span>(<span class="fu">head</span>(mtcars, <span class="dv">4</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="finding-help" class="level2">
<h2 class="anchored" data-anchor-id="finding-help">Finding help</h2>
<p>You should definitely read the incredibly short (+ free) chapter in <a href="https://r4ds.hadley.nz/workflow-help">R for Data Science</a> as a start. R is a widely-used language, which means that most errors will have cropped-up in some form before. In general, I’d suggest a thorough search for your term before asking for specific help. Some search tips:</p>
<ul>
<li>look in the help before anything online</li>
<li>be specific - mention package/function names and error messages. Often including the whole error message in quotes can sharpen things up a bit</li>
<li>include “R” in your search string to ensure you’re getting relevant results</li>
<li>you might also use the “site: stackoverflow.com” to restrict searches to one of the most useful and relevant sources there is</li>
</ul>
<p>Otherwise, assuming this fails, you should ask for help. I’d probably think about one of three venues for that:</p>
<ul>
<li>if you’re reading this, you already know about the <a href="https://forms.office.com/r/WQdd6HSCEW">KIND network</a>. We have a large R community - come and chat!</li>
<li>if you’re NHS, <a href="https://nhsrcommunity.com/">the NHS-R community</a> is great and full of friendly experts. They have an active Slack channel</li>
<li>otherwise, the big player is <a href="https://stackoverflow.com/questions/tagged/r">stackoverflow</a>. They can be fierce, but definitely some serious experts out there</li>
</ul>
<p>Wherever you ask for help, please help yourself:</p>
<ul>
<li>be sure you know about any local rules governing asking for help</li>
<li>search carefully to make sure you’re not the twentieth person this week asking the same question</li>
<li>a specific, but concise, question is the thing. Include the error message, give basic details about your setup (R 4.4.1, Rstudio, Windows, e.g) and <strong>include your reprex</strong> so that potential helpers don’t have to ask you for it</li>
</ul>
</section>
<section id="fancier-stuff" class="level2">
<h2 class="anchored" data-anchor-id="fancier-stuff">Fancier stuff</h2>
<p>As you write more complex code, I would want to add three more sets of tools. The first of these is <code>browser()</code>/breakpoints. These are mainly used to understand what’s going on inside functions. I’d recommend <a href="https://adv-r.hadley.nz/debugging.html">the chapter in Advanced R as an entry point</a> to these techniques.</p>
<p>I’d also want to start thinking more formally about methods and classes as this is a common cause of errors. The chapter on <a href="https://adv-r.hadley.nz/s3.html">S3 in Advanced R</a> is a good place to start, as is fooling around with the <a href="https://sloop.r-lib.org/">sloop package</a>.</p>
<p>The final strategy is to formalize and automate your testing. Again, well beyond the scope of this beginner’s session, but if you’re interested in this powerful approach for more advanced applications you can review our <a href="https://nes-dew.github.io/KIND-training/r_training/testing.html">unit testing materials</a> for an accessible introduction. - unit testing</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/NES-DEW\.github\.io\/KIND-training\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>