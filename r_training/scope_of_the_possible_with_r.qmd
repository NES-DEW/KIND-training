---
execute:
    echo: true
    cache: true
categories: [R, overview]
params:
  sl_date: 2025-12-09
  fn: Scope of the possible with R
  id: KR25
date: "`r params$sl_date`"
title: "`r params$fn`"
editor_options: 
  chunk_output_type: console
---

```{r}
#| include: false
#| eval: false

"Hello world!"

library(readr)

url <- "https://www.opendata.nhs.scot/dataset/0d57311a-db66-4eaa-bd6d-cc622b6cbdfa/resource/a5f7ca94-c810-41b5-a7c9-25c18d43e5a4/download/weekly_ae_activity_20251123.csv"

ae_activity <- read_csv(url)

names(ae_activity)

names(ae_activity) <- c("date", "country", "hb", "loc", "type", "attend", "n", "n_in_4", "n_4", "perc_4", "n_8", "perc_8", "n_12", "perc_12")

ae_activity

library(dplyr)

# cols
ae_activity |>
  select(-country)

# rows
ae_activity |>
  filter(attend == "All")

# combining
ae_activity |>
  select(-country) |>
  filter(attend == "All") |>
  select(date, hb, n)
  
# boards from https://www.opendata.nhs.scot/dataset/geography-codes-and-labels/resource/652ff726-e676-4a20-abda-435b98dd7bdc

boards <- read_csv("https://www.opendata.nhs.scot/dataset/9f942fdb-e59e-44f5-b534-d6e17229cc7b/resource/652ff726-e676-4a20-abda-435b98dd7bdc/download/hb14_hb19.csv")

library(lubridate)
library(ggplot2)

# nhs locations
# https://www.opendata.nhs.scot/dataset/nhs-scotland-accident-emergency-sites

locs <- read_csv("https://www.opendata.nhs.scot/dataset/a877470a-06a9-492f-b9e8-992f758894d0/resource/1a4e3f48-3d9b-4769-80e9-3ef6d27852fe/download/ae_hospital_site_list_09_09_2025.csv") |>
  select(2:4)

names(locs) <- c("loc_name", "loc", "postcode")

locs <- locs |>
  rowwise() |>
  mutate(long = PostcodesioR::postcode_lookup(postcode)$longitude,
         lat = PostcodesioR::postcode_lookup(postcode)$latitude)

ae_activity_locs <- ae_activity |>
  select(-country) |>
  filter(attend == "All") |>
  left_join(boards, by = join_by(hb == HB)) |>
  select(date, HBName, loc, type, n) |>
  mutate(date = ymd(date)) |>
  left_join(locs) 

ae_activity_locs |>
  filter(HBName == "NHS Highland") |>
  ggplot() +
  geom_line(aes(x = date, y = n, colour = loc_name))

# make reusable
graphmo <- function(hbname = "NHS Highland"){
  
  ae_activity |>
    select(-country) |>
    filter(attend == "All") |>
    left_join(boards, by = join_by(hb == HB)) |>
    select(date, HBName, loc, type, n) |>
    filter(HBName %in% hbname) |>
    mutate(date = ymd(date)) |>
    left_join(locs) |>
    ggplot() +
    geom_line(aes(x = date, y = n, colour = loc_name))+
    theme(legend.position = "bottom")
}


graphmo(boards$HBName)

# maps are just graphs
ae_activity_locs |>
  ggplot(aes(x = long, y = lat, label = loc_name, colour = HBName)) +
  geom_point()


# but also interactive maps are fun
ae_activity_locs |>
  distinct(long, lat, loc_name) |>
  leaflet::leaflet() |>
  leaflet::addTiles() |>
  leaflet::addMarkers(~long, ~lat, label = ~loc_name)

```

```{r}
#| echo: false
#| results: asis
#| fig-align: left
#| fig-height: 0.6
#| fig-width: 3

source(here::here("R/feed_block.R"))
# feed_block("Scope of the possible with R")
feed_block(params$id)
```

## Welcome

-   this session is a **non-technical overview** designed for service leads

## Session outline

-   Introducing R, and a bit of chat about the aims of this session
-   Practical demo - take some data, load, tidy, analyse, produce outputs
-   Strengths and weaknesses
    -   obvious
    -   less obvious
-   Alternatives
-   Skill development

## Introducing R

-   free and open-source statistical programming language
-   multi-platform
-   large user base
-   prominent in health, industry, biosciences

## Why this session?

-   R can be confusing
    -   it's code-based, and most of us don't have much code experience
    -   it's used for some inherently complicated tasks
    -   it's a big product with lots of add-ons and oddities
-   But R is probably the best general-purpose toolbox we have for data work at present
    -   big user base in health and social care
    -   focus on health and care-like applications
    -   not *that* hard to learn
    -   extensible and flexible
    -   capable of enterprise-y, fancy uses
-   yet there's signficant resistant to using R in parts of Scotland's health and care sector

## R demo

-   this is about showing what's possible, and give you a flavour of how R works
-   we won't explain code in detail during this session
-   using [live open data](https://www.opendata.nhs.scot/dataset/weekly-accident-and-emergency-activity-and-waiting-times) </br> ![https://www.opendata.nhs.scot/dataset/weekly-accident-and-emergency-activity-and-waiting-times](../src/images/clipboard-776150275.png)

## Hello world!

There are lots of ways to run R. In this session, we'll demonstrate using the Rstudio Desktop IDE on Windows.

```{r}
"Hello world!"
```

## Packages

R is highly extensible using packages: collections of useful code

```{r}
library(readr) # plus, nice to see R's folksy daft names for things in action
```

## Create variables

```{r}
url <- "https://www.opendata.nhs.scot/dataset/0d57311a-db66-4eaa-bd6d-cc622b6cbdfa/resource/a5f7ca94-c810-41b5-a7c9-25c18d43e5a4/download/weekly_ae_activity_20251123.csv"
```

## Load some open data

That's a link to data about weekly A+E activity. It's large-ish (approximately 40000 rows)

```{r}
#| eval: false
ae_activity <- read_csv(url)
```

```{r}
#| echo: false
# cheating to avoid burdening the open data every time this is rendered
ae_activity <- read_csv("data/weekly_ae_activity_20251123.csv")
```

## One small bit of cheating: renaming

```{r}
names(ae_activity) <- c("date", "country", "hb", "loc", "type", "attend", "n", "n_in_4", "n_4", "perc_4", "n_8", "perc_8", "n_12", "perc_12")
```

## Preview

```{r}
#| echo: false
library(dplyr)
ae_activity |>
    slice_sample(n = 5) |>
    knitr::kable(caption = "Preview of data")

```

## Removing data

```{r}
library(dplyr)

ae_activity <- ae_activity |>
    select(!c(country, contains("perc_")))
```

```{r}
#| echo: false
ae_activity |>
    slice_sample(n = 5) |>
    knitr::kable(caption = "Preview of data")

```

## Tidying data

```{r}
library(lubridate)

ae_activity <- ae_activity |>
    mutate(date = ymd(date))
```

```{r}
#| echo: false
ae_activity |>
    slice_sample(n = 5) |>
    knitr::kable(caption = "Preview of data")

```

## Subset data

We'll take a selection of 5 health boards to keep things tidy:

```{r}
boards_sample <- c("NHS Borders", "NHS Fife", "NHS Grampian", "NHS Highland", "NHS Lanarkshire")
```

## Joining data

Those board codes (like S08000020) aren't very easy to read. Luckily, we can add the proper "NHS Thing & Thing" board names from [another data source](%22https://www.opendata.nhs.scot/dataset/9f942fdb-e59e-44f5-b534-d6e17229cc7b/resource/652ff726-e676-4a20-abda-435b98dd7bdc/download/hb14_hb19.csv%22).

```{r}
boards <- read_csv("https://www.opendata.nhs.scot/dataset/9f942fdb-e59e-44f5-b534-d6e17229cc7b/resource/652ff726-e676-4a20-abda-435b98dd7bdc/download/hb14_hb19.csv")
```

```{r}
#| echo: false
boards |>
    slice_sample(n = 5) |>
    knitr::kable(caption = "NHS boards")

```

We can do something very similar with the A&E locations:

```{r}
locs <- read_csv("https://www.opendata.nhs.scot/dataset/a877470a-06a9-492f-b9e8-992f758894d0/resource/1a4e3f48-3d9b-4769-80e9-3ef6d27852fe/download/ae_hospital_site_list_09_09_2025.csv") |>
  select(2:4)

names(locs) <- c("loc_name", "loc", "postcode") # a bit of renaming to make the names easier
```

And we can add the postcodes:

```{r}
#| eval: false
locs <- locs |>
  rowwise() |>
  mutate(long = PostcodesioR::postcode_lookup(postcode)$longitude,
         lat = PostcodesioR::postcode_lookup(postcode)$latitude) # adding in some location information
```

```{r}
#| echo: false

if(file.exists("data/locs.rds")){
  
  locs <- readr::read_rds("data/locs.rds")
  
} else {
  
  locs <- locs |>
    rowwise() |>
    mutate(long = PostcodesioR::postcode_lookup(postcode)$longitude,
           lat = PostcodesioR::postcode_lookup(postcode)$latitude) # adding in some location information
  
  locs |>
    readr::write_rds("data/locs.rds")
}
```

We can then join our three datasets together to give us data with the NHS Board names, A&E names, and locations:

```{r}
ae_activity_locs <- ae_activity |>
  filter(attend == "All") |>
  left_join(boards, by = join_by(hb == HB)) |>
  filter(HBName %in% boards_sample) |>
  select(date, HBName, loc, type, n, contains("n_")) |>
  mutate(date = ymd(date)) |>
  left_join(locs) 
```

```{r}
#| echo: false
ae_activity_locs |>
    slice_sample(n = 5) |>
    knitr::kable(caption = "Data with NHS board, location, and location names")

```

## Basic plots

```{r}
library(ggplot2)

ae_activity_locs |>
  filter(HBName == "NHS Highland") |>
  ggplot() +
  geom_line(aes(x = date, y = n, colour = loc_name))

```

## Looking across different measures

```{r}
library(tidyr)

ae_activity_locs |>
  filter(loc_name == "Raigmore Hospital") |>
  select(date, n_in_4:n_12) |>
  pivot_longer(-date) |>
  group_by(date = floor_date(date, "month"), name) |>
  summarise(value = mean(value)) |>
  ggplot(aes(x = date, y = value, colour = name)) +
  geom_line() +
  geom_smooth(se = F)

```

## Making that re-usable

```{r}

graphmo <- function(hbname = "NHS Highland"){
  
  ae_activity_locs |>
    filter(HBName %in% hbname) |>
    ggplot() +
    geom_line(aes(x = date, y = n, colour = loc_name)) +
    theme(legend.position = "bottom") +
    xlab("Location") +
    labs(colour = "") # hide the label

}

graphmo(c("NHS Grampian", "NHS Fife"))
```

## A rubbish map

We've got latitude and longitude information for our A&E sites, which means we can plot them on a map:

```{r}
ae_activity_locs |>
  ggplot(aes(x = long, y = lat, label = loc_name, colour = HBName)) +
  geom_point() +
  theme_void() +
  theme(legend.position = "none")
```

That's not the most useful map I've ever seen. Luckily, there's a package to help us:

## Add to a map

```{r}
#| eval: false
ae_activity_locs |>
    leaflet::leaflet() |>
    leaflet::addTiles() |>
    leaflet::addMarkers(~long, ~lat, label = ~loc_name)
```

![Simple map](../src/images/clipboard-1597763797.png)

## Then make that map more useful

```{r}
#| eval: false

ae_activity_locs |>
    group_by(loc_name) |>
    summarise(n = sum(n), long = min(long), lat = min(lat)) |>
    mutate(rate = paste(loc_name, "averages", n, "attendees")) |>
    leaflet::leaflet() |>
    leaflet::addTiles() |>
    leaflet::addMarkers(~long, ~lat, label = ~rate)
```

![More useful map](../src/images/clipboard-385362493.png)

## Strengths

R offers enormous scope and flexibility, largely because of two features. First, R is based on the idea of packages, where you're encouraged to outsource specialist functions to your R installation in a repeatable and standard way. There's basically a package for everything - something over 20000 at present. Second, R encourages reproducible analytics: the idea being you write your script once, and then run it many times as your data changes, producing standardised outputs by design.

Together, that design makes R a force-multiplier for fancier data work: use packages to replicate your existing work in a reproducible way, then use the time saved in your routine reporting to improve and extend the work. There are other features of code-based analytics which make collaborating and developing more complex projects typically much smoother than they would be in non-code tools like Excel.

## Weaknesses

-   it's code, and it takes some time (months to years) to achieve real fluency
-   potentially harder to learn than some competitor languages and tools (Power BI, Python)
-   very patchy expertise across H+SC Scotland
-   complex IG landscape
-   messy skills development journey
